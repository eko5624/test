  
name: test

on:
  workflow_dispatch:
    
jobs:  
  build:
    runs-on: windows-2022
    steps:   
    - name: Set path
      shell: cmd
      run: |
        echo %PATH%

    - uses: actions/checkout@main
    - name: Release  
      shell: bash
      run: |
        id=$(curl -u eko5624:${{ github.token }} --connect-timeout 60 --retry 999 --retry-delay 5 --retry-all-errors -s -X POST -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/eko5624/mpv-win64/releases -d @- <<END | jq -r '.id'
        {
          "tag_name": "dev",
        }
        END
        )
        for f in vulkan-dev/*.zst; do curl -u eko5624:${{ github.token }} --connect-timeout 60 --retry 999 --retry-delay 5 --retry-all-errors -s -X POST -H "Accept: application/vnd.github.v3+json" -H "Content-Type: $(file -b --mime-type $f)" https://api.github.com/repos/eko5624/mpv-win64/releases/$id/assets?name=$(basename $f) --data-binary @$f; done
        

        
    - name: Get current date and random hash
      run: |
        echo "random_hash=$(echo $RANDOM | md5sum | head -c 20)" >> $GITHUB_ENV  
        
    - name: Get mpv latest commit sha
      id: mpv_sha
      uses: actions/github-script@v6
      with:
        script: |
          let mpv = {owner: 'mpv-player', repo: 'mpv', ref: 'master'}
          const commit = await github.rest.repos.getCommit(mpv)
          core.setOutput('sha', String(commit.data.sha))

    - name: Add MPV_SHORT_SHA env 
      run: echo "MPV_SHORT_SHA=`echo ${{ steps.mpv_sha.outputs.sha }}| cut -c1-7`" >> $GITHUB_ENV         
      shell: bash          
   
    - name: Display the path
      run: echo ${env:PATH}                

    - uses: actions/checkout@v3
    - name: Install Nasm
      run: |
        curl -OL https://www.nasm.us/pub/nasm/releasebuilds/2.15.05/win64/nasm-2.15.05-win64.zip 
        mkdir All-in-One
        cp test All-in-One
        7z x nasm* -o'All-in-One'
        7z a All-in-One.7z All-in-One/*

  macos-env:
    runs-on: macos-12
    steps:    
      - name: Set path
        run: |
          echo $PATH
          
  linux-env:
    runs-on: ubuntu-22.04
    steps:    
      - name: Set path
        run: |
          echo $PATH
          ls /usr/local/lib/android/sdk/ndk/23.2.8568313/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/vulkan
          ls /usr/local/lib/android/sdk/ndk/23.2.8568313/sources/third_party/vulkan/src/include/vulkan

name: brew

on:
  workflow_dispatch:
  #schedule:
  #  - cron: '0 0 * * MON'

jobs:
  test:
    runs-on: macos-12
    env:
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1 
    steps:   
    - name: test
      run: |       
        set -x
        mpv_deps=(
          libass
          vapoursynth
        )

        ffmpeg_deps=(
          dav1d
          fontconfig
          freetype
          frei0r            
        )
        all_deps=(brew deps -n --union --include-build --include-test "${mpv_deps[@]}" "${ffmpeg_deps[@]}")     
        echo "all deps..\n'${all_deps[@]}'"
        brew deps -n --union --include-build --include-test "${all_deps[@]}"
        sys_deps=(brew list)
        echo "sys deps..\n '${sys_deps[@]}'"
        if [[ del_dep in "${sys_deps[@]}" and del_dep in "${all_deps[@]}" ]]:
            brew uninstall "$del_dep --ignore-dependencies

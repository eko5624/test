name: brew

on:
  workflow_dispatch:
  #schedule:
  #  - cron: '0 0 * * MON'

jobs:
  test:
    runs-on: macos-12
    env:
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1 
    steps:   
    - name: test
      run: |       
        set -x
        mpv_deps=(
          libass
          vapoursynth
        )

        ffmpeg_deps=(
          dav1d
          fontconfig
          freetype
          frei0r            
        )
        all_deps=$(brew deps -n --union --include-build --include-test "${mpv_deps[@]}" "${ffmpeg_deps[@]}")     
        sys_deps=$(brew list)
        if del_dep in "${sys_deps[@]}" && del_dep in "${all_deps[@]}"; then
            brew uninstall "$del_dep --ignore-dependencies
        fi

        brew install "${all_deps[@]}" --ignore-dependencies
        brew install "${mpv_deps[@]}" "${ffmpeg_deps[@]}" --ignore-dependencies

name: check-sdk

on:
  workflow_dispatch:
  #schedule:
  #  - cron: '0 0 * * MON'

jobs:
  test:
    runs-on: macos-11
    env:
      SDKROOT: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"    
      MACOS_SDK: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
      SDK_PATH: "/Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs"
      SWIFT_FLAGS: "-target x86_64-apple-macosx10.13" 
    steps: 
    - name: Switch to MacOSX 10.15 SDK
      id: macossdk
      run: |
        curl -OL https://github.com/phracker/MacOSX-SDKs/releases/download/10.15/MacOSX10.15.sdk.tar.xz
        tar -C $SDK_PATH -xf MacOSX10.15.sdk.tar.xz
        sudo rm -rf $SDK_PATH/MacOSX11.3.sdk
        sudo rm $SDK_PATH/MacOSX.sdk
        sudo ln -s $SDK_PATH/MacOSX10.15.sdk $SDK_PATH/MacOSX.sdk
        sudo /usr/libexec/PlistBuddy -c "Set :MinimumSDKVersion 10.15" /Applications/Xcode_12.5.1.app/Contents/Developer/Platforms/MacOSX.platform/Info.plist
 
    - name: Install Swift 4.x toolchain
      id: swift4
      run: |
        #swift 4.x toolchain
        curl -ksJLO https://download.swift.org/swift-4.2.4-release/xcode/swift-4.2.4-RELEASE/swift-4.2.4-RELEASE-osx.pkg
        sudo installer -pkg swift-4.2.4-RELEASE-osx.pkg -target /
  
    - name: Switch to Xcode 12.5.1
      id: xcode1251
      run: |
        sudo xcode-select --reset
        sudo xcode-select -s /Applications/Xcode_12.5.1.app/Contents/Developer   
   
    - name: Check
      run: |
        echo "CommandLineTools sdks===="
        ls /Library/Developer/CommandLineTools/SDKs
        echo "show sdk path"
        sudo xcrun --sdk macosx --show-sdk-path
        echo "show MACOS_SDK ENV"
        echo "$MACOS_SDK"
        echo "toolchain swift version===="
        sudo xcrun --toolchain swift swift --version
        export TOOLCHAINS=org.swift.42420190329a
        echo "show TOOLCHAINS ENV===="
        echo "$TOOLCHAINS" 
        echo "show org.swift.42420190329a version===="
        sudo xcrun --toolchain swift swift --version    
     
